async function loadEPG() {
    try {
        // Fetch the local XML file generated by the GitHub Action
        const response = await fetch('./data.xml');
        const xmlText = await response.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, "text/xml");

        const channels = Array.from(xmlDoc.getElementsByTagName("channel"));
        const programmes = Array.from(xmlDoc.getElementsByTagName("programme"));
        const container = document.getElementById("epg-grid");

        container.innerHTML = '';

        // Displaying 30 popular Indian Channels
        channels.slice(0, 30).forEach(channel => {
            const channelId = channel.getAttribute("id");
            const channelName = channel.getElementsByTagName("display-name")[0].textContent;
            const channelIcon = channel.getElementsByTagName("icon")[0]?.getAttribute("src") || 'https://via.placeholder.com/50';

            const row = document.createElement("div");
            row.className = "channel-row";
            row.innerHTML = `
                <div class="channel-info">
                    <img src="${channelIcon}" width="30" style="margin-right:10px">
                    <span>${channelName}</span>
                </div>
                <div class="program-list" id="list-${channelId.replace(/\./g, '-')}"></div>
            `;
            container.appendChild(row);

            const listDiv = document.getElementById(`list-${channelId.replace(/\./g, '-')}`);

            // Filter programs for this specific channel
            programmes
                .filter(p => p.getAttribute("channel") === channelId)
                .forEach(prog => {
                    const title = prog.getElementsByTagName("title")[0].textContent;
                    const startTime = formatXMLTime(prog.getAttribute("start"));
                    
                    const card = document.createElement("div");
                    card.className = "program-card";
                    card.innerHTML = `
                        <strong>${title}</strong>
                        <div class="program-time">${startTime}</div>
                    `;
                    listDiv.appendChild(card);
                });
        });
    } catch (e) {
        console.error("EPG Load Error:", e);
        document.getElementById("epg-grid").innerHTML = "<p>Data currently updating... please refresh in a minute.</p>";
    }
}

function formatXMLTime(xmlString) {
    // Input: 20260111183000 +0530 -> Output: 18:30
    const hh = xmlString.substring(8, 10);
    const mm = xmlString.substring(10, 12);
    return `${hh}:${mm}`;
}

loadEPG();
